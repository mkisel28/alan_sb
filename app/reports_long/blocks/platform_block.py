"""
Блок данных по платформе
"""

from docx import Document
from docx.shared import Pt, RGBColor, Inches
from docx.enum.text import WD_ALIGN_PARAGRAPH
from typing import Dict
from ..utils import (
    format_number,
    format_percent,
    format_delta,
    get_platform_name,
    get_trend_description,
)
from .author_block import AuthorBlock
from .charts_block import ChartsBlock


class PlatformBlock:
    """Генерирует блок данных по платформе"""

    @staticmethod
    def add_to_document(doc: Document, platform_key: str, platform_data: Dict) -> None:
        """
        Добавляет блок платформы в документ

        Args:
            doc: Документ Word
            platform_key: Ключ платформы
            platform_data: Данные платформы
        """
        platform_name = get_platform_name(platform_key)
        agg = platform_data["aggregated"]
        authors = platform_data["authors"]

        # Заголовок платформы
        heading = doc.add_heading(platform_name.upper(), level=1)
        heading_run = heading.runs[0]
        heading_run.font.color.rgb = RGBColor(0, 102, 204)

        doc.add_paragraph()

        # Обзор платформы 
        overview_para1 = doc.add_paragraph()
        overview_text1 = (
            f"Настоящий раздел отчета посвящен комплексному анализу эффективности медиа-присутствия "
            f"на платформе {platform_name}, которая является одной из ключевых цифровых площадок для "
            f"взаимодействия с целевой аудиторией. Анализ охватывает деятельность "
            f"{agg['total_authors']} "
            f"{'автора' if agg['total_authors'] == 1 else 'авторов'}, "
            f"чья совокупная аудитория на данной платформе по состоянию на конец отчетного периода "
            f"составляет {format_number(agg['total_followers'])} подписчиков. "
            f"{'Значительный размер аудитории свидетельствует о существенном медийном присутствии и позволяет рассматривать данную платформу как важный канал коммуникации с целевыми сегментами.' if agg['total_followers'] >= 100000 else 'Размер аудитории характеризует устойчивое присутствие на платформе с потенциалом для дальнейшего масштабирования охвата.' if agg['total_followers'] >= 10000 else 'Текущий размер аудитории указывает на начальную стадию развития присутствия с существенными возможностями для роста.'}"
        )
        overview_run1 = overview_para1.add_run(overview_text1)
        overview_run1.font.size = Pt(11)

        doc.add_paragraph()

        overview_para2 = doc.add_paragraph()
        overview_text2 = (
            f"За анализируемый отчетный период на платформе {platform_name} было размещено в общей "
            f"сложности {format_number(agg['total_posts'])} "
            f"{'публикация' if agg['total_posts'] == 1 else 'публикации' if agg['total_posts'] < 5 else 'публикаций'}, "
            f"что свидетельствует о {'высокой' if agg['total_posts'] >= 50 else 'умеренной' if agg['total_posts'] >= 20 else 'базовой'} "
            f"публикационной активности. Опубликованный контент получил широкий резонанс в аудитории: "
            f"совокупное количество просмотров достигло {format_number(agg['total_views'])}, а общее "
            f"число вовлечений (включая лайки, комментарии, репосты и сохранения) составило "
            f"{format_number(agg['total_engagement'])}. Эти показатели характеризуют не только масштаб "
            f"медиа-присутствия, но и способность создаваемого контента генерировать активное "
            f"взаимодействие с аудиторией, что является критически важным фактором для эффективности "
            f"коммуникационной стратегии на данной платформе."
        )
        overview_run2 = overview_para2.add_run(overview_text2)
        overview_run2.font.size = Pt(11)

        doc.add_paragraph()

        overview_para3 = doc.add_paragraph()
        avg_views_per_post = (
            agg["total_views"] / agg["total_posts"] if agg["total_posts"] > 0 else 0
        )
        avg_engagement_per_post = (
            agg["total_engagement"] / agg["total_posts"]
            if agg["total_posts"] > 0
            else 0
        )
        overview_text3 = (
            f"Анализ эффективности в расчете на единицу контента показывает, что средняя публикация "
            f"на платформе {platform_name} получает приблизительно "
            f"{format_number(int(avg_views_per_post))} просмотров и "
            f"{format_number(int(avg_engagement_per_post))} вовлечений. "
            f"Эти показатели позволяют оценить типичную результативность контента на данной платформе "
            f"и служат ориентиром для бенчмаркинга индивидуальных результатов каждого автора. "
            f"Платформа {platform_name} характеризуется специфическими алгоритмами ранжирования контента "
            f"и особенностями поведения аудитории, которые необходимо учитывать при разработке и "
            f"реализации контент-стратегии. Понимание этих особенностей критически важно для максимизации "
            f"эффективности медиа-присутствия и достижения целей коммуникационной стратегии."
        )
        overview_run3 = overview_para3.add_run(overview_text3)
        overview_run3.font.size = Pt(11)

        doc.add_paragraph()

        # Агрегированные метрики
        doc.add_heading("Агрегированные показатели эффективности", level=2)

        metrics_para1 = doc.add_paragraph()
        metrics_text1 = (
            f"Интегральные показатели эффективности медиа-присутствия на платформе {platform_name} "
            f"рассчитываются как средние значения соответствующих метрик по всем анализируемым авторам. "
            f"Средний показатель Presence Score по платформе составляет {agg['avg_PS']:.1f} баллов из "
            f"максимально возможных 100, что характеризует {'высокий' if agg['avg_PS'] >= 75 else 'средний' if agg['avg_PS'] >= 50 else 'развивающийся'} "
            f"уровень медиа-присутствия на данной площадке. "
            f"{'Такой высокий средний PS свидетельствует об эффективной работе команды авторов на платформе и успешной реализации контент-стратегии.' if agg['avg_PS'] >= 75 else 'Средний уровень PS указывает на устойчивое присутствие с возможностями для дальнейшей оптимизации и улучшения показателей.' if agg['avg_PS'] >= 50 else 'Текущий уровень PS свидетельствует о начальной стадии развития присутствия с существенным потенциалом для роста.'} "
            f"Данный показатель агрегирует перцентильные оценки ключевых метрик присутствия и позволяет "
            f"объективно сравнивать эффективность работы на разных платформах."
        )
        metrics_run1 = metrics_para1.add_run(metrics_text1)
        metrics_run1.font.size = Pt(11)

        doc.add_paragraph()

        metrics_para2 = doc.add_paragraph()
        metrics_text2 = (
            f"Средний уровень вовлеченности по просмотрам (ER_view) на платформе {platform_name} "
            f"зафиксирован на уровне {format_percent(agg['avg_ER_view'] * 100)}, что является "
            f"критически важным показателем качества взаимодействия аудитории с контентом. "
            f"{'Высокий уровень вовлеченности свидетельствует об отличном резонансе контента с аудиторией и эффективной работе авторов по созданию материалов, стимулирующих активное взаимодействие.' if agg['avg_ER_view'] >= 0.05 else 'Средний уровень вовлеченности характерен для данной платформы и соответствует типичным показателям в отрасли.' if agg['avg_ER_view'] >= 0.02 else 'Текущий уровень вовлеченности указывает на потенциал для улучшения через оптимизацию контент-стратегии и внедрение более интерактивных форматов.'} "
            f"Показатель ER_view особенно важен для алгоритмов ранжирования контента на социальных "
            f"платформах, поскольку активное взаимодействие аудитории с публикациями положительно "
            f"влияет на их видимость и органический охват. Постоянный мониторинг и оптимизация данного "
            f"показателя должны находиться в фокусе внимания при управлении медиа-присутствием на платформе."
        )
        metrics_run2 = metrics_para2.add_run(metrics_text2)
        metrics_run2.font.size = Pt(11)

        doc.add_paragraph()

        if "avg_MS" in agg:
            metrics_para3 = doc.add_paragraph()
            metrics_text3 = (
                f"Momentum Score, характеризующий динамику развития присутствия на платформе, в среднем "
                f"составляет {agg['avg_MS']:.1f} баллов, что отражает {'сильный импульс роста и позитивную динамику развития' if agg['avg_MS'] >= 75 else 'умеренную позитивную динамику с потенциалом для ускорения роста' if agg['avg_MS'] >= 50 else 'замедленные темпы развития, требующие анализа и корректировки стратегии'} "
                f"медиа-присутствия на платформе {platform_name}. Данный показатель агрегирует изменения "
                f"ключевых метрик эффективности по всем авторам и позволяет оценить общий вектор развития "
                f"присутствия на платформе. {'Высокий средний MS свидетельствует о том, что платформа находится в фазе активного роста и развития, что создает благоприятные условия для дальнейшего масштабирования присутствия.' if agg['avg_MS'] >= 75 else 'Средний уровень MS указывает на стабильное развитие с возможностями для интенсификации роста через оптимизацию контент-стратегии и усиление механизмов вовлечения аудитории.' if agg['avg_MS'] >= 50 else 'Низкий средний MS требует детального анализа причин замедления роста и разработки комплексного плана действий по активизации развития на платформе.'} "
                f"Анализ Momentum Score в динамике позволяет своевременно выявлять изменения в траектории "
                f"развития и корректировать стратегию в соответствии с актуальными трендами и вызовами."
            )
            metrics_run3 = metrics_para3.add_run(metrics_text3)
            metrics_run3.font.size = Pt(11)

            doc.add_paragraph()

        # Динамика
        if "deltas" in agg:
            doc.add_heading(
                "Сравнительный анализ динамики: текущий период vs предыдущий период",
                level=2,
            )

            deltas = agg["deltas"]

            dynamics_para1 = doc.add_paragraph()
            dynamics_text1 = (
                f"Сопоставление агрегированных показателей текущего отчетного периода с аналогичными "
                f"показателями предыдущего периода позволяет выявить ключевые тренды и тенденции в "
                f"развитии медиа-присутствия на платформе {platform_name}. Детальный анализ изменений "
                f"по каждому ключевому показателю предоставляет важную информацию для оценки "
                f"эффективности реализуемой стратегии и выявления областей, требующих оптимизации или "
                f"корректировки подхода."
            )
            dynamics_run1 = dynamics_para1.add_run(dynamics_text1)
            dynamics_run1.font.size = Pt(11)

            doc.add_paragraph()

            dynamics_para2 = doc.add_paragraph()
            dynamics_text2 = (
                f"Изменение ключевых показателей платформы {platform_name}:\n\n"
            )

            # Подписчики
            dynamics_text2 += (
                f"• АУДИТОРИЯ (ПОДПИСЧИКИ): Зафиксирован {get_trend_description(deltas['followers']['percent'])} - "
                f"{format_delta(deltas['followers']['percent'], deltas['followers']['absolute'])}. "
            )
            if deltas["followers"]["percent"] > 5:
                dynamics_text2 += (
                    "Значительный рост аудитории свидетельствует об успешной реализации контент-стратегии "
                    "и растущем интересе пользователей к публикуемым материалам. Такая позитивная динамика "
                    "создает благоприятные условия для дальнейшего масштабирования присутствия на платформе."
                )
            elif deltas["followers"]["percent"] < -5:
                dynamics_text2 += (
                    "Снижение аудитории требует детального анализа причин и разработки плана корректирующих "
                    "действий. Необходимо провести аудит контент-стратегии и оценить факторы, которые "
                    "могли способствовать оттоку подписчиков."
                )
            else:
                dynamics_text2 += (
                    "Относительная стабильность размера аудитории при минимальных изменениях характерна "
                    "для зрелых каналов и требует внедрения новых подходов для стимулирования роста."
                )

            dynamics_text2 += "\n\n"

            # Публикации
            dynamics_text2 += (
                f"• ПУБЛИКАЦИОННАЯ АКТИВНОСТЬ: Количество публикаций показало {get_trend_description(deltas['posts']['percent'])} - "
                f"{format_delta(deltas['posts']['percent'], deltas['posts']['absolute'])}. "
            )
            if deltas["posts"]["percent"] > 10:
                dynamics_text2 += (
                    "Увеличение публикационной активности может способствовать росту охвата и видимости "
                    "на платформе, однако важно обеспечить поддержание высокого качества контента при "
                    "увеличении его объема."
                )
            elif deltas["posts"]["percent"] < -10:
                dynamics_text2 += (
                    "Снижение публикационной активности может быть обусловлено стратегическим фокусом на "
                    "качестве контента, однако необходимо оценить влияние данного изменения на общий охват "
                    "и видимость на платформе."
                )
            else:
                dynamics_text2 += (
                    "Стабильность публикационной активности указывает на устойчивый график выпуска контента, "
                    "что важно для поддержания постоянного присутствия в лентах подписчиков."
                )

            dynamics_text2 += "\n\n"

            # Просмотры
            dynamics_text2 += (
                f"• ОХВАТ (ПРОСМОТРЫ): Показатель просмотров продемонстрировал {get_trend_description(deltas['views']['percent'])} - "
                f"{format_delta(deltas['views']['percent'], deltas['views']['absolute'])}. "
            )
            if deltas["views"]["percent"] > 10:
                dynamics_text2 += (
                    "Существенный рост просмотров является критически важным позитивным сигналом, "
                    "указывающим на расширение охвата аудитории и повышение видимости контента в "
                    "алгоритмах платформы. Этот тренд свидетельствует об эффективности текущей стратегии "
                    "и создает основу для дальнейшего масштабирования присутствия."
                )
            elif deltas["views"]["percent"] < -10:
                dynamics_text2 += (
                    "Снижение просмотров требует немедленного анализа причин: это может быть связано с "
                    "изменениями алгоритмов платформы, снижением качества контента, либо возросшей "
                    "конкуренцией. Необходимо разработать комплексный план действий по восстановлению "
                    "показателей охвата."
                )
            else:
                dynamics_text2 += (
                    "Стабильность показателя просмотров при отсутствии значительных изменений может "
                    "указывать на достижение определенного равновесия, однако требует анализа возможностей "
                    "для дальнейшего роста охвата."
                )

            dynamics_text2 += "\n\n"

            # Вовлеченность
            dynamics_text2 += (
                f"• ВОВЛЕЧЕННОСТЬ (ENGAGEMENT): Общее количество вовлечений показало {get_trend_description(deltas['engagement']['percent'])} - "
                f"{format_delta(deltas['engagement']['percent'], deltas['engagement']['absolute'])}. "
            )
            if deltas["engagement"]["percent"] > 10:
                dynamics_text2 += (
                    "Рост вовлеченности является наиболее ценным показателем, так как свидетельствует об "
                    "активном взаимодействии аудитории с контентом. Высокая вовлеченность положительно "
                    "влияет на алгоритмы платформы и способствует органическому росту охвата."
                )
            elif deltas["engagement"]["percent"] < -10:
                dynamics_text2 += (
                    "Снижение вовлеченности требует пересмотра контент-стратегии с фокусом на создании "
                    "более интерактивного и эмоционально резонансного контента. Необходимо усилить "
                    "механизмы стимулирования активного взаимодействия аудитории."
                )
            else:
                dynamics_text2 += (
                    "Стабильность показателя вовлеченности свидетельствует о поддержании устойчивого "
                    "уровня взаимодействия с аудиторией, однако есть возможности для дальнейшего роста "
                    "через оптимизацию форматов и подходов."
                )

            dynamics_text2 += "\n\n"

            # ER_view
            dynamics_text2 += (
                f"• ENGAGEMENT RATE (ER_VIEW): Уровень вовлеченности по просмотрам изменился на "
                f"{format_delta(deltas['ER_view']['percent'], is_percent=True)}. "
            )
            if deltas["ER_view"]["percent"] > 5:
                dynamics_text2 += (
                    "Рост ER_view свидетельствует о повышении качества взаимодействия аудитории с контентом "
                    "относительно его охвата. Этот показатель критически важен для алгоритмов платформы и "
                    "должен быть в фокусе постоянного внимания."
                )
            elif deltas["ER_view"]["percent"] < -5:
                dynamics_text2 += (
                    "Снижение ER_view указывает на ослабление качества взаимодействия аудитории с контентом "
                    "и требует срочных мер по оптимизации контент-стратегии и усилению механизмов вовлечения."
                )
            else:
                dynamics_text2 += (
                    "Стабильность ER_view при незначительных колебаниях характеризует устойчивость качества "
                    "взаимодействия с аудиторией на данном уровне."
                )

            dynamics_run2 = dynamics_para2.add_run(dynamics_text2)
            dynamics_run2.font.size = Pt(10)

            doc.add_paragraph()

        # Графики по платформе
        try:
            # График средних просмотров
            labels = [a["author_name"] for a in authors]
            v_avg_values = [a["metrics"]["V_avg"] for a in authors]

            chart_stream = ChartsBlock.create_bar_chart(
                labels,
                v_avg_values,
                f"Средние просмотры на пост - {platform_name}",
                "Просмотры",
                color="#4A90E2",
            )
            doc.add_picture(chart_stream, width=Inches(6))
            doc.paragraphs[-1].alignment = WD_ALIGN_PARAGRAPH.CENTER

            doc.add_paragraph()

            # График ER
            er_values = [a["metrics"]["ER_view"] * 100 for a in authors]

            chart_stream = ChartsBlock.create_bar_chart(
                labels,
                er_values,
                f"Engagement Rate - {platform_name}",
                "ER (%)",
                color="#67C23A",
            )
            doc.add_picture(chart_stream, width=Inches(6))
            doc.paragraphs[-1].alignment = WD_ALIGN_PARAGRAPH.CENTER

            doc.add_paragraph()

        except Exception as e:
            error_para = doc.add_paragraph()
            error_run = error_para.add_run(f"[Графики недоступны: {str(e)}]")
            error_run.font.italic = True
            error_run.font.color.rgb = RGBColor(255, 0, 0)

        # Детальные данные по каждому автору
        doc.add_heading("Детальный анализ по авторам", level=2)

        for idx, author_data in enumerate(authors, start=1):
            AuthorBlock.add_to_document(doc, author_data, platform_name)

            # Разделитель между авторами
            if idx < len(authors):
                doc.add_paragraph("_" * 70)
                doc.add_paragraph()

        # Разрыв страницы после платформы
        doc.add_page_break()
