"""
Блок данных по автору
"""

from docx import Document
from docx.shared import Pt, RGBColor, Inches
from docx.enum.text import WD_ALIGN_PARAGRAPH
from typing import Dict
from ..utils import (
    format_number,
    format_percent,
    format_delta,
    interpret_ps,
    interpret_ms,
    interpret_er,
    get_trend_description,
)
from .charts_block import ChartsBlock


class AuthorBlock:
    """Генерирует блок с подробными данными по автору"""

    @staticmethod
    def add_to_document(doc: Document, author_data: Dict, platform_name: str) -> None:
        """
        Добавляет блок автора в документ

        Args:
            doc: Документ Word
            author_data: Данные автора
            platform_name: Название платформы
        """
        metrics = author_data["metrics"]
        scores = author_data["scores"]
        author_name = author_data["author_name"]
        username = author_data["username"]

        has_previous = "prev_metrics" in metrics
        prev_metrics = metrics.get("prev_metrics", {})

        # Заголовок автора
        heading = doc.add_heading(f"{author_name} (@{username})", level=3)
        heading_run = heading.runs[0]
        heading_run.font.color.rgb = RGBColor(0, 102, 204)

        # Основные метрики - расширенное описание
        summary_para1 = doc.add_paragraph()
        summary_text1 = (
            f"Автор {author_name} (идентификатор в социальной сети: @{username}) на платформе "
            f"{platform_name} демонстрирует следующие результаты присутствия в социальных медиа. "
            f"По состоянию на конец отчетного периода аудитория данного автора насчитывает "
            f"{format_number(metrics['F'])} подписчиков"
        )

        if has_previous and "F" in prev_metrics:
            prev_f = prev_metrics["F"]
            delta_f = metrics["F"] - prev_f
            delta_f_pct = (delta_f / prev_f * 100) if prev_f > 0 else 0
            summary_text1 += (
                f", что представляет собой {'прирост' if delta_f > 0 else 'снижение' if delta_f < 0 else 'сохранение'} "
                f"на {format_delta(delta_f_pct, delta_f)} по сравнению с предыдущим периодом, "
                f"когда аудитория составляла {format_number(prev_f)} подписчиков"
            )

        summary_text1 += (
            ". Данный показатель характеризует совокупный охват потенциальной аудитории автора "
            "и является базовым индикатором медийного присутствия в цифровом пространстве. "
            "Размер аудитории напрямую влияет на максимально возможный органический охват "
            "публикаций и определяет потенциал влияния автора в своей тематической нише."
        )
        summary_run1 = summary_para1.add_run(summary_text1)
        summary_run1.font.size = Pt(11)

        doc.add_paragraph()

        summary_para2 = doc.add_paragraph()
        summary_text2 = (
            f"За анализируемый отчетный период автором {author_name} было создано и опубликовано "
            f"{metrics['P']} {'публикация' if metrics['P'] == 1 else 'публикации' if metrics['P'] < 5 else 'публикаций'}"
        )

        if has_previous and "P" in prev_metrics:
            prev_p = prev_metrics["P"]
            delta_p = metrics["P"] - prev_p
            delta_p_pct = (delta_p / prev_p * 100) if prev_p > 0 else 0
            summary_text2 += (
                f". В предыдущем периоде количество публикаций составляло {prev_p} "
                f"{'публикацию' if prev_p == 1 else 'публикации' if prev_p < 5 else 'публикаций'}, "
                f"таким образом публикационная активность показала {get_trend_description(delta_p_pct)} "
                f"({format_delta(delta_p_pct, delta_p)})"
            )

        summary_text2 += (
            f". Регулярность и интенсивность публикационной активности являются критически важными "
            f"факторами для поддержания видимости автора в новостных лентах подписчиков и в "
            f"рекомендательных алгоритмах платформы. {'Высокая' if metrics['P'] >= 10 else 'Умеренная' if metrics['P'] >= 5 else 'Низкая'} "
            f"публикационная активность в текущем периоде {'способствует поддержанию постоянного контакта с аудиторией и обеспечивает регулярное появление в лентах подписчиков' if metrics['P'] >= 10 else 'позволяет поддерживать базовый уровень присутствия, хотя может быть недостаточной для максимизации охвата' if metrics['P'] >= 5 else 'может ограничивать потенциал роста аудитории и снижать видимость автора в алгоритмах платформы'}."
        )
        summary_run2 = summary_para2.add_run(summary_text2)
        summary_run2.font.size = Pt(11)

        doc.add_paragraph()

        summary_para3 = doc.add_paragraph()
        summary_text3 = (
            f"Совокупный охват публикаций автора {author_name} за отчетный период составил "
            f"{format_number(metrics['V'])} просмотров, при этом среднее количество просмотров "
            f"в расчете на одну публикацию достигло {format_number(int(metrics['V_avg']))} просмотров"
        )

        if has_previous and "V_avg" in prev_metrics:
            prev_v_avg = prev_metrics["V_avg"]
            delta_v_avg = metrics["V_avg"] - prev_v_avg
            delta_v_avg_pct = (delta_v_avg / prev_v_avg * 100) if prev_v_avg > 0 else 0
            summary_text3 += (
                f". В предыдущем периоде средние просмотры на публикацию составляли "
                f"{format_number(int(prev_v_avg))}, что означает {get_trend_description(delta_v_avg_pct)} "
                f"данного показателя ({format_delta(delta_v_avg_pct, is_percent=True)}) в текущем периоде"
            )

        summary_text3 += (
            f". Показатель средних просмотров на публикацию (V_avg) является ключевым индикатором "
            f"эффективности контента и его способности привлекать внимание аудитории. В отличие от "
            f"общего количества просмотров, которое зависит от объема публикаций, средний показатель "
            f"позволяет оценить качество отдельных материалов и их соответствие интересам аудитории. "
            f"{'Высокий' if metrics['V_avg'] >= metrics['F'] * 0.5 else 'Умеренный' if metrics['V_avg'] >= metrics['F'] * 0.1 else 'Низкий'} "
            f"уровень средних просмотров относительно размера аудитории "
            f"{'свидетельствует об отличной видимости контента в алгоритмах платформы и высоком интересе аудитории к публикуемым материалам' if metrics['V_avg'] >= metrics['F'] * 0.5 else 'указывает на базовый уровень охвата, который может быть улучшен через оптимизацию контент-стратегии и форматов публикаций' if metrics['V_avg'] >= metrics['F'] * 0.1 else 'требует анализа причин низкой видимости и корректировки подхода к созданию контента'}."
        )
        summary_run3 = summary_para3.add_run(summary_text3)
        summary_run3.font.size = Pt(11)

        doc.add_paragraph()

        summary_para4 = doc.add_paragraph()
        summary_text4 = (
            f"Анализ вовлеченности аудитории показывает следующие результаты: общее количество "
            f"вовлечений (включая все формы активного взаимодействия пользователей с контентом - "
            f"лайки, комментарии, репосты и сохранения) составило {format_number(metrics['E'])} "
            f"за отчетный период"
        )

        if has_previous and "E" in prev_metrics:
            prev_e = prev_metrics["E"]
            delta_e = metrics["E"] - prev_e
            delta_e_pct = (delta_e / prev_e * 100) if prev_e > 0 else 0
            summary_text4 += (
                f", что представляет {get_trend_description(delta_e_pct)} "
                f"({format_delta(delta_e_pct, delta_e)}) по сравнению с предыдущим периодом, "
                f"когда общее количество вовлечений составляло {format_number(prev_e)}"
            )

        summary_text4 += (
            f". При этом ключевой показатель эффективности - уровень вовлеченности по просмотрам "
            f"(ER_view) - зафиксирован на уровне {format_percent(metrics['ER_view'] * 100)}, "
            f"что характеризуется как {interpret_er(metrics['ER_view'])}"
        )

        if has_previous and "ER_view" in prev_metrics:
            prev_er = prev_metrics["ER_view"]
            delta_er = metrics["ER_view"] - prev_er
            delta_er_pct = (delta_er / prev_er * 100) if prev_er > 0 else 0
            summary_text4 += (
                f". В предыдущем периоде ER_view составлял {format_percent(prev_er * 100)} "
                f"({interpret_er(prev_er)}), что означает {'улучшение' if delta_er > 0 else 'снижение' if delta_er < 0 else 'сохранение'} "
                f"показателя на {format_delta(delta_er_pct, is_percent=True)}"
            )

        summary_text4 += (
            ". Показатель ER_view является критически важной метрикой, поскольку он отражает "
            "не просто пассивное потребление контента (просмотры), а активное взаимодействие "
            "аудитории с публикациями. Высокий уровень вовлеченности положительно влияет на "
            "ранжирование контента в алгоритмах социальных платформ, способствуя увеличению "
            "органического охвата и видимости последующих публикаций. Данный показатель также "
            "служит индикатором качества контента и его резонанса с целевой аудиторией."
        )
        summary_run4 = summary_para4.add_run(summary_text4)
        summary_run4.font.size = Pt(11)

        doc.add_paragraph()

        summary_para5 = doc.add_paragraph()
        summary_text5 = (
            f"Дополнительный анализ качественных характеристик вовлеченности показывает, что "
            f"показатель Share Rate (SR) - доля репостов среди всех просмотров - составляет "
            f"{format_percent(metrics['SR'] * 100, 3)}"
        )

        if has_previous and "SR" in prev_metrics:
            prev_sr = prev_metrics["SR"]
            delta_sr = metrics["SR"] - prev_sr
            delta_sr_pct = (delta_sr / prev_sr * 100) if prev_sr > 0 else 0
            summary_text5 += (
                f" (в предыдущем периоде: {format_percent(prev_sr * 100, 3)}, "
                f"изменение: {format_delta(delta_sr_pct, is_percent=True)})"
            )

        summary_text5 += (
            f", а Comment Rate (CR) - доля комментариев - находится на уровне "
            f"{format_percent(metrics['CR'] * 100, 3)}"
        )

        if has_previous and "CR" in prev_metrics:
            prev_cr = prev_metrics["CR"]
            delta_cr = metrics["CR"] - prev_cr
            delta_cr_pct = (delta_cr / prev_cr * 100) if prev_cr > 0 else 0
            summary_text5 += (
                f" (в предыдущем периоде: {format_percent(prev_cr * 100, 3)}, "
                f"изменение: {format_delta(delta_cr_pct, is_percent=True)})"
            )

        summary_text5 += (
            ". Эти детализированные метрики позволяют глубже понять характер взаимодействия "
            "аудитории с контентом: репосты свидетельствуют о высокой ценности контента для "
            "пользователей, достаточной для того, чтобы делиться им со своей аудиторией, в то "
            "время как комментарии указывают на способность контента генерировать обсуждения "
            "и провоцировать активную реакцию пользователей. Сбалансированное соотношение "
            "различных типов вовлечения свидетельствует о многогранном восприятии контента "
            "аудиторией и его способности удовлетворять различные потребности пользователей."
        )
        summary_run5 = summary_para5.add_run(summary_text5)
        summary_run5.font.size = Pt(11)

        doc.add_paragraph()

        # Детальная таблица метрик
        doc.add_heading("Детальные метрики", level=4)

        table = doc.add_table(rows=9, cols=3 if has_previous else 2)
        table.style = "Light Grid Accent 1"

        # Заголовки
        headers = ["Метрика", "Текущий период"]
        if has_previous:
            headers.append("Предыдущий период")

        for idx, header in enumerate(headers):
            cell = table.rows[0].cells[idx]
            cell.text = header
            for paragraph in cell.paragraphs:
                for run in paragraph.runs:
                    run.font.bold = True
                    run.font.size = Pt(10)

        # Данные
        rows_data = [
            (
                "Подписчики (F)",
                format_number(metrics["F"]),
                format_number(prev_metrics.get("F", 0)) if has_previous else "",
            ),
            (
                "Публикации (P)",
                str(metrics["P"]),
                str(prev_metrics.get("P", 0)) if has_previous else "",
            ),
            (
                "Просмотры всего (V)",
                format_number(metrics["V"]),
                format_number(prev_metrics.get("V", 0)) if has_previous else "",
            ),
            (
                "Средние просмотры (V_avg)",
                format_number(int(metrics["V_avg"])),
                format_number(int(prev_metrics.get("V_avg", 0)))
                if has_previous
                else "",
            ),
            (
                "Вовлечения всего (E)",
                format_number(metrics["E"]),
                format_number(prev_metrics.get("E", 0)) if has_previous else "",
            ),
            (
                "ER по просмотрам",
                format_percent(metrics["ER_view"] * 100),
                format_percent(prev_metrics.get("ER_view", 0) * 100)
                if has_previous
                else "",
            ),
            (
                "Share Rate (SR)",
                format_percent(metrics["SR"] * 100, 3),
                format_percent(prev_metrics.get("SR", 0) * 100, 3)
                if has_previous
                else "",
            ),
            (
                "Comment Rate (CR)",
                format_percent(metrics["CR"] * 100, 3),
                format_percent(prev_metrics.get("CR", 0) * 100, 3)
                if has_previous
                else "",
            ),
        ]

        for idx, row_data in enumerate(rows_data, start=1):
            for col_idx, value in enumerate(row_data):
                table.rows[idx].cells[col_idx].text = value
                for paragraph in table.rows[idx].cells[col_idx].paragraphs:
                    for run in paragraph.runs:
                        run.font.size = Pt(9)

        doc.add_paragraph()

        # Динамика
        if has_previous:
            doc.add_heading(
                "Детальный анализ динамики: текущий период vs предыдущий период",
                level=4,
            )

            dynamics_para1 = doc.add_paragraph()

            # Расчет изменений
            delta_f_pct = metrics["delta_F_percent"] * 100
            delta_v_pct = metrics.get("delta_V_avg_percent", 0) * 100
            delta_er_pct = metrics.get("delta_ER_percent", 0) * 100

            dynamics_text1 = (
                f"Сопоставление ключевых показателей эффективности текущего периода с аналогичными "
                f"показателями предыдущего периода позволяет выявить важные тенденции в развитии "
                f"медиа-присутствия автора {author_name}. Прежде всего, необходимо отметить динамику "
                f"изменения аудитории: в текущем периоде зафиксирован {get_trend_description(delta_f_pct)} "
                f"количества подписчиков ({format_delta(delta_f_pct, metrics['delta_F'])}). "
            )

            if delta_f_pct > 5:
                dynamics_text1 += (
                    "Значительный прирост аудитории свидетельствует об успешной реализации "
                    "контент-стратегии, высокой релевантности публикуемых материалов интересам "
                    "целевой аудитории, а также эффективной работе алгоритмов платформы по "
                    "рекомендации контента новым потенциальным подписчикам. Такая положительная "
                    "динамика создает благоприятные предпосылки для дальнейшего масштабирования "
                    "медиа-присутствия и увеличения влияния автора в своей тематической нише."
                )
            elif delta_f_pct < -5:
                dynamics_text1 += (
                    "Снижение количества подписчиков требует детального анализа причин: это может "
                    "быть связано с изменениями в контент-стратегии, недостаточной регулярностью "
                    "публикаций, снижением качества или релевантности контента, либо общими "
                    "изменениями в алгоритмах платформы. Важно провести аудит контента последнего "
                    "периода и скорректировать стратегию для восстановления позитивной динамики "
                    "роста аудитории. Отток подписчиков может также указывать на необходимость "
                    "обновления формата контента или расширения тематического фокуса."
                )
            else:
                dynamics_text1 += (
                    "Относительная стабильность размера аудитории при отсутствии значительных "
                    "изменений может свидетельствовать о достижении определенного равновесия между "
                    "притоком новых подписчиков и оттоком существующих. Данная ситуация типична "
                    "для зрелых каналов с устоявшейся аудиторией и требует внедрения новых подходов "
                    "для стимулирования дальнейшего роста, таких как кросс-промоушн, коллаборации "
                    "с другими авторами или диверсификация контентных форматов."
                )

            dynamics_run1 = dynamics_para1.add_run(dynamics_text1)
            dynamics_run1.font.size = Pt(11)

            doc.add_paragraph()

            dynamics_para2 = doc.add_paragraph()
            dynamics_text2 = (
                f"Анализ динамики охвата контента показывает, что средние просмотры на одну "
                f"публикацию продемонстрировали {get_trend_description(delta_v_pct)} "
                f"({format_delta(delta_v_pct, is_percent=True)}) по сравнению с предыдущим периодом. "
            )

            if delta_v_pct > 10:
                dynamics_text2 += (
                    "Существенное увеличение средних просмотров является исключительно позитивным "
                    "сигналом, свидетельствующим о повышении качества контента, улучшении его "
                    "позиционирования в алгоритмах платформы, либо успешном освоении новых форматов "
                    "и подходов к созданию контента. Рост данного показателя особенно ценен, так как "
                    "он отражает увеличение охвата в расчете на единицу контента, что означает "
                    "повышение эффективности медиа-присутствия. Важно зафиксировать факторы, "
                    "способствовавшие такому росту, и интегрировать их в долгосрочную контент-стратегию."
                )
            elif delta_v_pct < -10:
                dynamics_text2 += (
                    "Снижение средних просмотров на публикацию является тревожным сигналом, требующим "
                    "немедленного анализа и корректирующих действий. Возможные причины включают: "
                    "изменения в алгоритмах ранжирования платформы, снижение качества или релевантности "
                    "контента, увеличение конкуренции в нише, либо 'усталость' аудитории от определенных "
                    "форматов или тем. Рекомендуется провести детальный аудит контента последнего периода, "
                    "проанализировать наиболее и наименее успешные публикации, а также рассмотреть "
                    "возможность экспериментов с новыми форматами, темами и подходами к созданию контента."
                )
            else:
                dynamics_text2 += (
                    "Стабильность показателя средних просмотров при незначительных колебаниях указывает "
                    "на устойчивость текущей контент-стратегии и предсказуемость реакции аудитории. "
                    "Однако отсутствие роста данного показателя может также свидетельствовать о достижении "
                    "определенного 'потолка' органического охвата, преодоление которого требует качественных "
                    "изменений в подходе к созданию и продвижению контента. Рекомендуется рассмотреть "
                    "возможности для экспериментов с новыми форматами, оптимизации времени публикаций, "
                    "а также применения передовых практик вовлечения аудитории."
                )

            dynamics_run2 = dynamics_para2.add_run(dynamics_text2)
            dynamics_run2.font.size = Pt(11)

            doc.add_paragraph()

            dynamics_para3 = doc.add_paragraph()
            dynamics_text3 = (
                f"Уровень вовлеченности аудитории (ER_view) претерпел изменения, составив "
                f"{format_delta(delta_er_pct, is_percent=True)} по сравнению с предыдущим периодом. "
            )

            if delta_er_pct > 5:
                dynamics_text3 += (
                    "Рост уровня вовлеченности является наиболее ценным достижением, поскольку он "
                    "свидетельствует о повышении качества взаимодействия аудитории с контентом. "
                    "Увеличение ER_view положительно влияет на видимость контента в алгоритмах платформы, "
                    "способствует расширению органического охвата и создает благоприятные условия для "
                    "роста аудитории. Данный тренд указывает на то, что контент становится более "
                    "резонансным, эмоционально вовлекающим и ценным для целевой аудитории. Критически "
                    "важно идентифицировать элементы и подходы, которые способствовали росту вовлеченности, "
                    "и системно применять их в последующих публикациях."
                )
            elif delta_er_pct < -5:
                dynamics_text3 += (
                    "Снижение уровня вовлеченности является серьезным вызовом, требующим комплексного "
                    "анализа и стратегической корректировки подхода к созданию контента. Падение ER_view "
                    "может быть обусловлено несколькими факторами: снижением эмоционального отклика "
                    "аудитории на контент, недостаточной интерактивностью публикаций, отсутствием четких "
                    "призывов к действию (call-to-action), либо общей усталостью аудитории от определенных "
                    "форматов или тем. Необходимо провести детальный анализ наиболее вовлекающего контента "
                    "предыдущих периодов, изучить успешные практики конкурентов и лидеров ниши, а также "
                    "рассмотреть возможность внедрения более интерактивных форматов, проведения опросов, "
                    "конкурсов и других механизмов стимулирования активного взаимодействия аудитории."
                )
            else:
                dynamics_text3 += (
                    "Стабильность уровня вовлеченности при минимальных колебаниях свидетельствует о "
                    "поддержании устойчивых отношений с аудиторией и предсказуемой реакции на контент. "
                    "Однако в условиях динамично развивающейся среды социальных медиа отсутствие роста "
                    "вовлеченности может рассматриваться как упущенная возможность для усиления влияния "
                    "и расширения охвата. Рекомендуется экспериментировать с новыми форматами контента, "
                    "тестировать различные подходы к вовлечению аудитории, внедрять интерактивные элементы "
                    "и систематически анализировать обратную связь от подписчиков для выявления их "
                    "неудовлетворенных потребностей и интересов."
                )

            dynamics_run3 = dynamics_para3.add_run(dynamics_text3)
            dynamics_run3.font.size = Pt(11)

            doc.add_paragraph()

        # Оценки
        doc.add_heading("Интегральные оценки эффективности и позиционирования", level=4)

        scores_para1 = doc.add_paragraph()

        ps_text1 = (
            f"Интегральный показатель Presence Score (PS) автора {author_name} составляет "
            f"{scores['PS']} баллов из максимально возможных 100, что соответствует категории "
            f'"{interpret_ps(scores["PS"])}" в общей классификации эффективности медиа-присутствия. '
            f"Данный комплексный показатель рассчитывается на основе перцентильного ранжирования "
            f"четырех ключевых метрик присутствия относительно всех других авторов, представленных "
            f"на данной платформе в отчетном периоде: средних просмотров на публикацию (V_avg), "
            f"уровня вовлеченности по просмотрам (ER_view), индекса виральности (Virality Index) "
            f"и темпов роста аудитории (Growth Rate). "
        )

        if "percentiles" in scores:
            pct = scores["percentiles"]
            ps_text1 += (
                f"Детальная разбивка показывает следующие перцентили: средние просмотры - "
                f"{pct.get('V_avg', 0):.1f}-й перцентиль"
            )
            if has_previous and "prev_percentiles" in scores:
                prev_pct = scores["prev_percentiles"]
                ps_text1 += f" (в предыдущем периоде: {prev_pct.get('V_avg', 0):.1f}-й перцентиль)"

            ps_text1 += f", вовлеченность - {pct.get('ER_view', 0):.1f}-й перцентиль"
            if has_previous and "prev_percentiles" in scores:
                ps_text1 += f" (в предыдущем периоде: {prev_pct.get('ER_view', 0):.1f}-й перцентиль)"

            ps_text1 += (
                f", виральность - {pct.get('virality_index', 0):.1f}-й перцентиль"
            )
            if has_previous and "prev_percentiles" in scores:
                ps_text1 += f" (в предыдущем периоде: {prev_pct.get('virality_index', 0):.1f}-й перцентиль)"

            ps_text1 += (
                f", рост аудитории - {pct.get('growth_rate', 0):.1f}-й перцентиль"
            )
            if has_previous and "prev_percentiles" in scores:
                ps_text1 += f" (в предыдущем периоде: {prev_pct.get('growth_rate', 0):.1f}-й перцентиль)"

            ps_text1 += "."

        scores_run1 = scores_para1.add_run(ps_text1)
        scores_run1.font.size = Pt(11)

        doc.add_paragraph()

        scores_para2 = doc.add_paragraph()
        ps_text2 = ""

        if has_previous and "prev_PS" in scores:
            ps_delta = scores["PS"] - scores["prev_PS"]
            ps_text2 = (
                f"Сравнительный анализ показывает, что в предыдущем периоде Presence Score данного "
                f"автора составлял {scores['prev_PS']} баллов, таким образом в текущем периоде "
                f"зафиксировано {'повышение' if ps_delta > 0 else 'снижение' if ps_delta < 0 else 'сохранение'} "
                f"показателя на {abs(ps_delta):.1f} {'балла' if abs(ps_delta) == 1 else 'баллов'} "
                f"({format_delta(ps_delta, is_percent=False)}). "
            )

            if ps_delta > 5:
                ps_text2 += (
                    "Значительное улучшение Presence Score свидетельствует о существенном прогрессе "
                    "в эффективности медиа-присутствия и укреплении позиций автора относительно "
                    "конкурентов на платформе. Такая позитивная динамика является результатом "
                    "комплексного улучшения ключевых показателей и указывает на правильность выбранной "
                    "стратегии развития. Рекомендуется продолжать применение успешных практик и подходов, "
                    "которые способствовали такому росту."
                )
            elif ps_delta < -5:
                ps_text2 += (
                    "Существенное снижение Presence Score указывает на ослабление позиций автора "
                    "относительно других участников платформы и требует детального анализа причин. "
                    "Падение PS может быть вызвано как абсолютным ухудшением собственных показателей, "
                    "так и опережающим ростом показателей конкурентов. Необходимо провести комплексный "
                    "аудит контент-стратегии и разработать план корректирующих действий для восстановления "
                    "конкурентных позиций."
                )
            else:
                ps_text2 += (
                    "Относительная стабильность Presence Score при минимальных изменениях говорит о "
                    "сохранении текущих позиций относительно других авторов платформы. Однако в условиях "
                    "высококонкурентной среды социальных медиа отсутствие роста показателя может "
                    "рассматриваться как упущенная возможность для усиления позиций и расширения влияния."
                )
        else:
            ps_text2 = (
                f"Значение Presence Score в {scores['PS']} баллов позволяет позиционировать данного "
                f"автора в {'верхнем сегменте' if scores['PS'] >= 75 else 'среднем сегменте' if scores['PS'] >= 50 else 'развивающемся сегменте'} "
                f"авторов платформы. {'Такой высокий показатель свидетельствует о сильном медиа-присутствии, эффективной контент-стратегии и способности генерировать качественное взаимодействие с аудиторией.' if scores['PS'] >= 75 else 'Этот уровень характеризует стабильное присутствие с потенциалом для дальнейшего роста и оптимизации отдельных показателей.' if scores['PS'] >= 50 else 'Данный показатель указывает на начальную стадию развития медиа-присутствия с существенным потенциалом для улучшения ключевых метрик.'}"
            )

        scores_run2 = scores_para2.add_run(ps_text2)
        scores_run2.font.size = Pt(11)

        doc.add_paragraph()

        # Momentum Score
        if "MS" in scores:
            ms_para1 = doc.add_paragraph()
            ms_text1 = (
                f"Momentum Score (MS), отражающий динамику и 'импульс' развития канала автора, "
                f"показывает значение {scores['MS']} баллов, что характеризует "
                f"{interpret_ms(scores['MS']).lower()} автора в сравнении с другими участниками "
                f"платформы. Этот важнейший индикатор рассчитывается на основе перцентильного "
                f"ранжирования показателей динамики, включая изменение средних просмотров, "
                f"изменение уровня вовлеченности и темпы роста аудитории относительно конкурентов. "
                f"В отличие от Presence Score, который отражает текущее состояние медиа-присутствия, "
                f"Momentum Score фокусируется на трендах и векторе развития, позволяя выявить "
                f"авторов с растущим влиянием даже при относительно небольших абсолютных показателях."
            )
            ms_run1 = ms_para1.add_run(ms_text1)
            ms_run1.font.size = Pt(11)

            doc.add_paragraph()

            ms_para2 = doc.add_paragraph()
            ms_text2 = ""

            if scores["MS"] >= 75:
                ms_text2 = (
                    f"Высокий Momentum Score в {scores['MS']} баллов является исключительно позитивным "
                    f"сигналом, свидетельствующим о стремительном развитии канала и опережающем росте "
                    f"ключевых показателей по сравнению с большинством других авторов платформы. Такая "
                    f"динамика указывает на эффективность текущей стратегии, высокую адаптивность к "
                    f"изменениям алгоритмов платформы и растущий резонанс контента с аудиторией. "
                    f"Авторы с высоким MS представляют собой 'восходящие звезды' платформы и имеют "
                    f"отличные перспективы для дальнейшего масштабирования влияния при условии "
                    f"сохранения текущего вектора развития."
                )
            elif scores["MS"] >= 50:
                ms_text2 = (
                    f"Средний уровень Momentum Score ({scores['MS']} баллов) характеризует умеренную "
                    f"позитивную динамику развития, соответствующую средним показателям по платформе. "
                    f"Автор демонстрирует стабильный рост основных метрик, хотя темпы развития не "
                    f"являются выдающимися по сравнению с наиболее динамично растущими каналами. "
                    f"Данный уровень MS указывает на потенциал для ускорения роста через оптимизацию "
                    f"контент-стратегии, экспериментирование с новыми форматами и усиление механизмов "
                    f"вовлечения аудитории."
                )
            else:
                ms_text2 = (
                    f"Относительно низкий Momentum Score ({scores['MS']} баллов) свидетельствует о "
                    f"замедленной динамике развития по сравнению с большинством других авторов платформы. "
                    f"Это может быть обусловлено стагнацией ключевых показателей, снижением темпов роста "
                    f"аудитории или падением уровней вовлеченности и охвата. Низкий MS является сигналом "
                    f"для проведения комплексного аудита контент-стратегии, анализа успешных практик "
                    f"конкурентов и разработки плана действий по активизации роста. Важно отметить, что "
                    f"низкий MS не обязательно означает плохие абсолютные показатели - он может также "
                    f"характеризовать зрелые каналы с большой аудиторией, для которых высокие темпы "
                    f"процентного роста становятся сложнодостижимыми."
                )

            ms_run2 = ms_para2.add_run(ms_text2)
            ms_run2.font.size = Pt(11)

            doc.add_paragraph()

        # График метрик
        try:
            chart_stream = ChartsBlock.create_metrics_comparison(
                author_name, metrics, prev_metrics if has_previous else None
            )
            doc.add_picture(chart_stream, width=Inches(6))
            doc.paragraphs[-1].alignment = WD_ALIGN_PARAGRAPH.CENTER
        except Exception as e:
            error_para = doc.add_paragraph()
            error_run = error_para.add_run(f"[График недоступен: {str(e)}]")
            error_run.font.italic = True
            error_run.font.color.rgb = RGBColor(255, 0, 0)

        doc.add_paragraph()
